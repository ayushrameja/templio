name: Automated Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'

permissions:
  contents: write
  pull-requests: read

jobs:
  release:
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get PR number from merge commit
        id: get_pr
        run: |
          PR_NUMBER=$(git log -1 --pretty=%B | grep -oP '#\K\d+' || echo "")
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Found PR number: $PR_NUMBER"

      - name: Get PR labels
        id: get_labels
        if: steps.get_pr.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.get_pr.outputs.pr_number }}';
            if (!prNumber) {
              console.log('No PR number found, defaulting to patch');
              return 'patch';
            }

            try {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: parseInt(prNumber)
              });
              
              const labels = pr.labels.map(label => label.name);
              console.log('PR labels:', labels);
              
              if (labels.includes('version:major')) {
                return 'major';
              } else if (labels.includes('version:minor')) {
                return 'minor';
              } else {
                return 'patch';
              }
            } catch (error) {
              console.log('Error fetching PR, defaulting to patch:', error.message);
              return 'patch';
            }

      - name: Determine version bump
        id: version_type
        run: |
          VERSION_TYPE="${{ steps.get_labels.outputs.result }}"
          if [ -z "$VERSION_TYPE" ] || [ "$VERSION_TYPE" == "undefined" ]; then
            VERSION_TYPE="patch"
          fi
          echo "type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "Version bump type: $VERSION_TYPE"

      - name: Bump version
        id: bump_version
        run: |
          VERSION_TYPE="${{ steps.version_type.outputs.type }}"
          npm version $VERSION_TYPE --no-git-tag-version
          pnpm install --lockfile-only
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Get previous tag
        id: previous_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREV_TAG"

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG="${{ steps.previous_tag.outputs.tag }}"
          NEW_VERSION="${{ steps.bump_version.outputs.version }}"

          echo "Generating changelog from $PREV_TAG to HEAD"

          CHANGELOG=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- Initial release"
          fi

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Commit version bump
        run: |
          git add package.json pnpm-lock.yaml
          git commit -m "chore: bump version to ${{ steps.bump_version.outputs.version }} [skip ci]" || echo "No changes to commit"
          git push origin main

      - name: Create and push tag
        run: |
          NEW_VERSION="${{ steps.bump_version.outputs.version }}"
          git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION"
          git push origin "v$NEW_VERSION"

      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.bump_version.outputs.version }}';
            const changelog = `${{ steps.changelog.outputs.changelog }}`;

            const releaseNotes = `## What's Changed\n\n${changelog}\n\n**Full Changelog**: https://github.com/${context.repo.owner}/${context.repo.repo}/compare/${{ steps.previous_tag.outputs.tag }}...v${version}`;

            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${version}`,
              name: `v${version}`,
              body: releaseNotes,
              draft: false,
              prerelease: version.includes('alpha') || version.includes('beta')
            });
